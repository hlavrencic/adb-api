# Configuración de Home Assistant para ADB Control API
# 
# Este archivo de ejemplo muestra cómo integrar la API de Control ADB con Home Assistant
# usando shell_commands para ejecutar comandos en dispositivos Android de forma remota.
#
# ⚙️  CONFIGURACIÓN REQUERIDA:
# La URL de la API se define en secrets.yaml (más seguro)
# O reemplaza "adb_api_url_secret" directamente en el campo {% raw %}"{{ adb_api_url }}"{% endraw %} en los rest_command
#
# En secrets.yaml, añade:
#   adb_api_url: "http://localhost:8000"
#
# Si prefieres hardcoding, reemplaza directamente en las URLs de rest_command:
# - Local (mismo host): http://localhost:8000
# - Remoto: http://192.168.0.25100:8000 (ajusta IP y puerto según tu red)
#
# INSTALACIÓN:
# 1. Copia el contenido relevant a tu archivo configuration.yaml de Home Assistant
# 2. Reemplaza la URL de la API arriba según tu configuración
# 3. Reinicia Home Assistant o recarga la configuración
#
# NOTA: La API debe estar corriendo y accesible desde Home Assistant
# Default: http://localhost:8000 (si está en el mismo host)

# ============================================================================
# CONFIGURACIÓN GENERAL DE HOME ASSISTANT
# ============================================================================

homeassistant:
  name: Home
  latitude: !secret latitude
  longitude: !secret longitude
  elevation: 0
  unit_system: metric
  time_zone: America/Argentina/Buenos_Aires
  customize: !include customize.yaml


rest_command:
  # ========== Device Management ==========
  adb_connect_device:
    url: "http://192.168.0.251:9123/devices/connect?ip={{ device_ip }}&port=5555"
    method: POST
  
  adb_disconnect_device:
    url: "http://192.168.0.251:9123/devices/disconnect?device_ip={{ device_ip }}"
    method: POST
  
  adb_list_devices:
    url: "http://192.168.0.251:9123/devices"
    method: GET
  
  adb_check_status:
    url: "http://192.168.0.251:9123/status?device_ip={{ device_ip }}"
    method: GET
  
  adb_health:
    url: "http://192.168.0.251:9123/"
    method: GET
  
  # ========== Device Information ==========
  adb_device_info:
    url: "http://192.168.0.251:9123/device/info?device_ip={{ device_ip }}"
    method: GET
  
  adb_current_app:
    url: "http://192.168.0.251:9123/device/current-app?device_ip={{ device_ip }}"
    method: GET
  
  adb_installed_apps:
    url: "http://192.168.0.251:9123/device/installed-apps?device_ip={{ device_ip }}&limit=30"
    method: GET
  
  adb_logcat:
    url: "http://192.168.0.251:9123/device/logcat?device_ip={{ device_ip }}&lines=50"
    method: GET
  
  # ========== Volume Control ==========
  adb_volume_current:
    url: "http://192.168.0.251:9123/device/volume/current?device_ip={{ device_ip }}"
    method: GET
  
  adb_volume_up:
    url: "http://192.168.0.251:9123/device/volume/increase?device_ip={{ device_ip }}&steps={{ steps | default(1) }}"
    method: POST
  
  adb_volume_down:
    url: "http://192.168.0.251:9123/device/volume/decrease?device_ip={{ device_ip }}&steps={{ steps | default(1) }}"
    method: POST
  
  adb_volume_mute:
    url: "http://192.168.0.251:9123/device/volume/mute?device_ip={{ device_ip }}"
    method: POST
  
  adb_volume_set:
    url: "http://192.168.0.251:9123/device/volume/set?device_ip={{ device_ip }}&level={{ level }}"
    method: POST
  
  # ========== Video Control ==========
  adb_play_video:
    url: "http://192.168.0.251:9123/play?device_ip={{ device_ip }}&video_url={{ video_url }}"
    method: POST
  
  adb_pause_video:
    url: "http://192.168.0.251:9123/stop?device_ip={{ device_ip }}"
    method: POST
  
  adb_exit_app:
    url: "http://192.168.0.251:9123/exit?device_ip={{ device_ip }}"
    method: POST
  
  # ========== Device Operations ==========
  adb_custom_command:
    url: "http://192.168.0.251:9123/command?device_ip={{ device_ip }}&command={{ command }}"
    method: POST

# ============================================================================
# SCRIPT HELPERS - Unificados por funcionalidad con parámetro 'action'
# ============================================================================
# Cada script maneja múltiples acciones usando un parámetro 'action'

script:
  # =================================================================================
  # DEVICE MANAGEMENT - Conectar, desconectar, listar, verificar estado
  # =================================================================================
  
  adb_device:
    description: "Gestión de dispositivos ADB (conectar, desconectar, listar, estado)"
    fields:
      action:
        description: "Acción a realizar"
        selector:
          select:
            options:
              - connect
              - disconnect
              - list
              - status
              - health
        default: "connect"
      device_ip:
        description: "IP del dispositivo (requerido para: disconnect, status)"
        example: "192.168.0.161"
        default: "192.168.0.161"
      port:
        description: "Puerto (opcional, default: 5555 para connect)"
        example: 5555
    sequence:
      - condition: template
        value_template: "{{ action is defined and action | length > 0 }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ action == 'connect' }}"
            sequence:
              - condition: template
                value_template: "{{ ip is defined and ip | length > 0 }}"
              - service: rest_command.adb_connect_device
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Conectando a {{ device_ip }}: {{ result.status }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'disconnect' }}"
            sequence:
              - condition: template
                value_template: "{{ device_ip is defined and device_ip | length > 0 }}"
              - service: rest_command.adb_disconnect_device
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Desconectando {{ device_ip }}: {{ result.status }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'list' }}"
            sequence:
              - service: rest_command.adb_list_devices
                response_variable: result
              - service: notify.notify
                data:
                  message: "Dispositivos listados: {{ result.json | length }} dispositivos"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'status' }}"
            sequence:
              - condition: template
                value_template: "{{ device_ip is defined and device_ip | length > 0 }}"
              - service: rest_command.adb_check_status
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Estado: {{ result.json.status | default('desconocido') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'health' }}"
            sequence:
              - service: rest_command.adb_health
                response_variable: result
              - service: notify.notify
                data:
                  message: "API Status: {{ result.json.status | default('OK') }}"
        default:
          - service: notify.notify
            data:
              message: "ERROR adb_device: Acción '{{ action }}' desconocida. Use: connect, disconnect, list, status o health"
  
  # =================================================================================
  # DEVICE INFORMATION - Obtener info, app actual, apps instaladas, logs
  # =================================================================================
  
  adb_info:
    description: "Información del dispositivo (info, app actual, apps instaladas, logs)"
    fields:
      action:
        description: "Acción a realizar"
        selector:
          select:
            options:
              - info
              - current_app
              - installed_apps
              - logcat
        default: "info"
      device_ip:
        description: "IP del dispositivo Android"
        example: "192.168.0.161"
        default: "192.168.0.161"
      limit:
        description: "Límite de apps (para installed_apps, default: 30)"
        example: 30
      lines:
        description: "Número de líneas de log (para logcat, default: 50)"
        example: 50
    sequence:
      - condition: template
        value_template: "{{ device_ip is defined and device_ip | length > 0 }}"
      - condition: template
        value_template: "{{ action is defined and action | length > 0 }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ action == 'info' }}"
            sequence:
              - service: rest_command.adb_device_info
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Info: {{ result.json | to_json }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'current_app' }}"
            sequence:
              - service: rest_command.adb_current_app
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "App actual: {{ result.json.app_name | default('N/A') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'installed_apps' }}"
            sequence:
              - service: rest_command.adb_installed_apps
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Instaladas: {{ result.json | length }} apps"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'logcat' }}"
            sequence:
              - service: rest_command.adb_logcat
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Logcat obtenido: {{ result.json | length }} líneas"
        default:
          - service: notify.notify
            data:
              message: "ERROR adb_info: Acción '{{ action }}' desconocida. Use: info, current_app, installed_apps o logcat"
  
  # =================================================================================
  # VOLUME CONTROL - Obtener volumen, aumentar, disminuir, establecer, silenciar
  # =================================================================================
  
  adb_volume:
    description: "Control de volumen (get, up, down, set, mute)"
    fields:
      action:
        description: "Acción a realizar"
        selector:
          select:
            options:
              - get
              - up
              - down
              - set
              - mute
        default: "get"
      device_ip:
        description: "IP del dispositivo Android"
        example: "192.168.0.161"
        default: "192.168.0.161"
      steps:
        description: "Pasos para up/down (default: 1) o nivel para set (0-15)"
        example: 1
    sequence:
      - condition: template
        value_template: "{{ device_ip is defined and device_ip | length > 0 }}"
      - condition: template
        value_template: "{{ action is defined and action | length > 0 }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ action == 'get' }}"
            sequence:
              - service: rest_command.adb_volume_current
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Volumen: {{ result.json.level | default('N/A') }}/15"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'up' }}"
            sequence:
              - service: rest_command.adb_volume_up
                data:
                  device_ip: "{{ device_ip }}"
                  steps: "{{ steps | default(1) }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Volumen +{{ steps | default(1) }} → {{ result.json.level | default('N/A') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'down' }}"
            sequence:
              - service: rest_command.adb_volume_down
                data:
                  device_ip: "{{ device_ip }}"
                  steps: "{{ steps | default(1) }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Volumen -{{ steps | default(1) }} → {{ result.json.level | default('N/A') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'set' }}"
            sequence:
              - condition: template
                value_template: "{{ steps is defined and steps | int(0) >= 0 and steps | int(0) <= 15 }}"
              - service: rest_command.adb_volume_set
                data:
                  device_ip: "{{ device_ip }}"
                  level: "{{ steps }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Volumen fijado a {{ steps }}/15: {{ result.json.status | default('OK') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'mute' }}"
            sequence:
              - service: rest_command.adb_volume_mute
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Silenciado: {{ result.json.status | default('OK') }}"
        default:
          - service: notify.notify
            data:
              message: "ERROR adb_volume: Acción '{{ action }}' desconocida. Use: get, up, down, set o mute"
  
  # =================================================================================
  # MEDIA CONTROL - Reproducir, pausar, salir
  # =================================================================================
  
  adb_media:
    description: "Control de medios (play, pause, exit)"
    fields:
      action:
        description: "Acción a realizar"
        selector:
          select:
            options:
              - play
              - pause
              - exit
        default: "play"
      device_ip:
        description: "IP del dispositivo Android"
        example: "192.168.0.161"
        default: "192.168.0.161"
      video_url:
        description: "URL de video (requerido para: play)"
        example: "https://www.youtube.com/watch?v=VIDEO_ID"
    sequence:
      - condition: template
        value_template: "{{ device_ip is defined and device_ip | length > 0 }}"
      - condition: template
        value_template: "{{ action is defined and action | length > 0 }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ action == 'play' }}"
            sequence:
              - condition: template
                value_template: "{{ video_url is defined and video_url | length > 0 }}"
              - service: rest_command.adb_play_video
                data:
                  device_ip: "{{ device_ip }}"
                  video_url: "{{ video_url }}"
                response_variable: result
              - delay:
                  seconds: 2
              - service: notify.notify
                data:
                  message: "Reproduciéndose: {{ result.json.status | default('OK') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'pause' }}"
            sequence:
              - service: rest_command.adb_pause_video
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Pausado: {{ result.json.status | default('OK') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'exit' }}"
            sequence:
              - service: rest_command.adb_exit_app
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Cerrada: {{ result.json.status | default('OK') }}"
        default:
          - service: notify.notify
            data:
              message: "ERROR adb_media: Acción '{{ action }}' desconocida. Use: play, pause o exit"
  
  # =================================================================================
  # SYSTEM - Tomar screenshot, ejecutar comandos
  # =================================================================================
  
  adb_system:
    description: "Operaciones del sistema (screenshot, comando)"
    fields:
      action:
        description: "Acción a realizar"
        selector:
          select:
            options:
              - screenshot
              - command
        default: "screenshot"
      device_ip:
        description: "IP del dispositivo Android"
        example: "192.168.0.161"
        default: "192.168.0.161"
      command:
        description: "Comando ADB a ejecutar (requerido para: command)"
        example: "pm list packages"
    sequence:
      - condition: template
        value_template: "{{ device_ip is defined and device_ip | length > 0 }}"
      - condition: template
        value_template: "{{ action is defined and action | length > 0 }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ action == 'screenshot' }}"
            sequence:
              - service: rest_command.adb_check_status
                data:
                  device_ip: "{{ device_ip }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Screenshot: {{ result.json.status | default('OK') }}"
          
          - conditions:
              - condition: template
                value_template: "{{ action == 'command' }}"
            sequence:
              - condition: template
                value_template: "{{ command is defined and command | length > 0 }}"
              - service: rest_command.adb_custom_command
                data:
                  device_ip: "{{ device_ip }}"
                  command: "{{ command }}"
                response_variable: result
              - service: notify.notify
                data:
                  message: "Comando: {{ result.json | to_json }}"
        default:
          - service: notify.notify
            data:
              message: "ERROR adb_system: Acción '{{ action }}' desconocida. Use: screenshot o command"

# ============================================================================
# REST SENSOR - Para monitoreo en tiempo real (OPCIONAL)
# ============================================================================
# Si quieres monitorear el estado de la API, puedes usar un REST sensor
# Descomenta y adapta según tu versión de Home Assistant

# Opción 1: Para Home Assistant 2023.12 y anteriores
# rest:
#   - resource: "http://192.168.0.251:9123/"
#     method: GET
#     scan_interval: 30
#     sensor:
#       - name: "ADB API Health"
#         unique_id: adb_api_health
#         value_template: "{{ value_json.status }}"

# Opción 2: Para Home Assistant 2024.1 y posteriores
# rest:
#   - scan_interval: 30
#     resource: "http://192.168.0.251:9123/"
#     sensor:
#       - name: "ADB API Health"
#         unique_id: adb_api_health
#         value_template: "{{ value_json.status }}"

# ============================================================================
# TEMPLATE SENSORS - Para información procesada
# ============================================================================

template:
  - sensor:
      - name: "ADB API Status"
        unique_id: adb_api_status
        state: "{{ state_attr('rest_api_adb_api_health', 'status') | default('unknown') }}"
        icon: mdi:api
      
      - name: "ADB Connected Devices"
        unique_id: adb_connected_devices
        state: "{{ state_attr('rest_api_adb_api_health', 'connected_devices') | default('0') }}"
        icon: mdi:android
        unit_of_measurement: "devices"

# ============================================================================
# EJEMPLOS DE USO - 5 Scripts Unificados con Parámetro 'action'
# ============================================================================
#
# Todos los endpoints están accesibles a través de 5 scripts principales,
# cada uno con un parámetro 'action' que define qué operación ejecutar.
#
# SCRIPTS DISPONIBLES:
#
# 1. script.adb_device - Gestión de dispositivos
#    Actions: connect, disconnect, list, status, health
#
# 2. script.adb_info - Información del dispositivo
#    Actions: info, current_app, installed_apps, logcat
#
# 3. script.adb_volume - Control de volumen
#    Actions: get, up, down, set, mute
#
# 4. script.adb_media - Control de medios
#    Actions: play, pause, exit
#
# 5. script.adb_system - Operaciones del sistema
#    Actions: screenshot, command
#
# ============================================================================
# EJEMPLOS DE LLAMADAS
# ============================================================================
#
# EJEMPLO 1: Conectar a un dispositivo
#   Service: script.adb_device
#   Data:
#     action: "connect"
#     ip: "192.168.0.161"
#
# EJEMPLO 2: Obtener información del dispositivo
#   Service: script.adb_info
#   Data:
#     action: "info"
#     device_ip: "192.168.0.161"
#
# EJEMPLO 3: Obtener app actual
#   Service: script.adb_info
#   Data:
#     action: "current_app"
#     device_ip: "192.168.0.161"
#
# EJEMPLO 4: Aumentar volumen 3 pasos
#   Service: script.adb_volume
#   Data:
#     action: "up"
#     device_ip: "192.168.0.161"
#     steps: 3
#
# EJEMPLO 5: Establecer volumen a nivel 7
#   Service: script.adb_volume
#   Data:
#     action: "set"
#     device_ip: "192.168.0.161"
#     steps: 7
#
# EJEMPLO 6: Silenciar dispositivo
#   Service: script.adb_volume
#   Data:
#     action: "mute"
#     device_ip: "192.168.0.161"
#
# EJEMPLO 7: Reproducir video de YouTube
#   Service: script.adb_media
#   Data:
#     action: "play"
#     device_ip: "192.168.0.161"
#     video_url: "https://www.youtube.com/watch?v=VIDEO_ID"
#
# EJEMPLO 8: Pausar reproducción
#   Service: script.adb_media
#   Data:
#     action: "pause"
#     device_ip: "192.168.0.161"
#
# EJEMPLO 9: Ejecutar comando personalizado
#   Service: script.adb_system
#   Data:
#     action: "command"
#     device_ip: "192.168.0.161"
#     command: "pm list packages"
#
# EJEMPLO 10: Tomar screenshot
#   Service: script.adb_system
#   Data:
#     action: "screenshot"
#     device_ip: "192.168.0.161"
#
# EJEMPLO 11: Listar dispositivos conectados
#   Service: script.adb_device
#   Data:
#     action: "list"
#
# EJEMPLO 12: Verificar salud de la API
#   Service: script.adb_device
#   Data:
#     action: "health"
#
# ============================================================================
# NOTAS IMPORTANTES
# ============================================================================
#
# 1. ACCESO A LA API:
#    - Local: Si Home Assistant está en el mismo host que la API, usa http://localhost:8000
#    - Remoto: Si está en otro host, usa http://IP_API:8000
#    - Ejemplo: http://192.168.0.25100:8000
#
# 2. SEGURIDAD:
#    - NO guardes IPs o URLs sensibles en configuration.yaml visible
#    - Usa !secret para datos sensibles
#    - Ejemplo: device_ip: !secret adb_device_ip
#
# 3. PERMISOS:
#    - rest_command es nativo de Home Assistant, no requiere permisos adicionales
#    - No necesita curl u otras herramientas externas instaladas
#
# 4. DEBUGGING:
#    - Revisa los logs de Home Assistant: tail -f home-assistant.log
#    - Usa curl directamente para probar endpoints:
#      curl "http://localhost:8000/devices"
#
# 5. PARAMETRIZACIÓN:
#    - Usa input_helpers (input_text, input_number, input_boolean) para
#      parametrizar valores en automaciones y scripts
#    - Accede con: {{ states('input_text.adb_device_ip') }}
#
# 6. CARACTERÍSTICAS DE REST_COMMAND:
#    - Nativo de Home Assistant, sin dependencias externas
#    - No requiere curl u otras herramientas instaladas
#    - Mejor seguridad y aislamiento
#    - Más fácil de mantener y depurar
#    - Funciona en cualquier plataforma (Docker, Linux, Windows)
#    - Soporta todos los endpoints de la API
#
# ============================================================================
